---
// Hero.astro
import { Image } from "astro:assets";
---

<section id="hero" class="relative w-full h-screen overflow-hidden">
	<div id="video-background" class="absolute inset-0 w-full h-full">
		<div
			id="image-placeholder"
			class="absolute inset-0 bg-cover bg-center bg-no-repeat z-10 transition-opacity duration-1000 animate-zoom"
		>
			<Image
				src="/assets/images/hero-background.webp"
				alt="Hero background"
				class="w-full h-full object-cover"
				width={1920}
				height={1080}
				loading="eager"
				format="webp"
			/>
		</div>
		<div
			id="video-container"
			class="w-full h-full opacity-0 transition-opacity duration-1000 z-20"
		>
			<video
				id="background-video"
				class="w-full h-full object-cover"
				autoplay
				loop
				muted
				playsinline
				preload="auto"></video>
		</div>
		<div id="overlay" class="absolute inset-0 bg-black bg-opacity-50 z-30">
		</div>
		<div
			class="absolute inset-0 flex flex-col justify-between items-center p-4 text-white z-40"
		>
			<div
				class="flex-grow flex flex-col justify-center items-center text-center w-full md:w-[30%] max-w-4xl mx-auto"
			>
				<div
					class="mb-4 flex items-center bg-black bg-opacity-50 p-2 rounded"
				>
					<Image
						src="/images/map.svg"
						alt="Icono de mapa"
						class="w-6 h-6 mr-2"
						width={24}
						height={24}
						loading="lazy"
					/>
					<span class="text-lg md:text-xl font-semibold"
						>Avenida Petapa Zona 12</span
					>
				</div>
				<h1
					class="text-4xl md:text-5xl font-bold mb-6 font-play leading-tight"
				>
					ESTRENA LA YAMAHA DE TUS SUEÑOS
				</h1>
				<p class="text-xl md:text-2xl">
					Gran inauguración 12 de Agosto de 2024
				</p>
			</div>
			<Image
				src="/images/arrow_down.png"
				alt="Flecha hacia abajo"
				class="w-8 h-8 md:w-12 md:h-12"
				width={48}
				height={48}
				loading="lazy"
			/>
		</div>
	</div>
</section>

<style>
	@keyframes zoom {
		0% {
			transform: scale(1.05);
		}
		100% {
			transform: scale(1.15);
		}
	}

	.animate-zoom {
		animation: zoom 8s infinite alternate;
	}

	.font-play {
		font-family: "Play", sans-serif;
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		const videoContainer = document.getElementById("video-container");
		const imagePlaceholder = document.getElementById("image-placeholder");
		const video = document.getElementById(
			"background-video",
		) as HTMLVideoElement;

		if (video) {
			const videoUrl = "/assets/hero-background.mp4";

			// Crear un MediaSource
			const mediaSource = new MediaSource();
			video.src = URL.createObjectURL(mediaSource);

			mediaSource.addEventListener("sourceopen", async () => {
				const sourceBuffer = mediaSource.addSourceBuffer(
					'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',
				);

				try {
					const response = await fetch(videoUrl);
					const reader = response.body.getReader();

					let chunks = [];
					let totalSize = 0;

					while (true) {
						const { done, value } = await reader.read();

						if (done) break;

						chunks.push(value);
						totalSize += value.length;

						// Agregar chunk al sourceBuffer
						const chunk = new Uint8Array(totalSize);
						let offset = 0;
						for (let i = 0; i < chunks.length; i++) {
							chunk.set(chunks[i], offset);
							offset += chunks[i].length;
						}

						sourceBuffer.appendBuffer(chunk);

						// Limpiar chunks después de agregarlos al buffer
						chunks = [];
						totalSize = 0;

						// Comenzar la reproducción tan pronto como haya suficientes datos
						if (!video.paused && sourceBuffer.buffered.length > 0) {
							video.play().catch(console.error);
						}
					}

					mediaSource.endOfStream();
				} catch (error) {
					console.error("Error al cargar el video:", error);
				}
			});

			video.addEventListener("canplay", () => {
				setTimeout(() => {
					if (videoContainer) videoContainer.style.opacity = "1";
					if (imagePlaceholder) imagePlaceholder.style.opacity = "0";
				}, 1500);
			});

			// Manejar la reproducción en dispositivos móviles
			document.body.addEventListener(
				"touchstart",
				function playVideoOnTouch() {
					video.play().catch(console.error);
					document.body.removeEventListener(
						"touchstart",
						playVideoOnTouch,
					);
				},
				{ once: true },
			);
		}
	});
</script>
